import unittest
import os

from utils.request import get_request
from vulnerability_gap.vg4 import VG4_IncreaseSize

class TestVG4(unittest.TestCase):
    def test_modify_encoder(self):
        modified_image_path = "./resources/modified/VG4_modified_test.png"
        headers, encoder = get_request()
        modified_encoder = VG4_IncreaseSize.modify_encoder(encoder)

        self.assertEqual(headers["Connection"], "keep-alive")
        self.assertEqual(headers["User-Agent"], os.getenv("USER_AGENT"))
        self.assertEqual(headers["Content-Type"], encoder.content_type)

        self.assertEqual(len(modified_encoder.fields), 2)
        self.assertGreater(os.path.getsize(modified_image_path), 8000000)
        
        encoder.fields["image"][1].close()
        modified_encoder.fields["image"][1].close()

if __name__ == '__main__':
    unittest.main()