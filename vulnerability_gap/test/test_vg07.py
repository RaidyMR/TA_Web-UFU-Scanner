import unittest
import os

from utils.request import get_request
from vulnerability_gap.vg7 import VG7_AddingResourceHeader

class TestVG7(unittest.TestCase):
    def test_prepending_resource_header(self):
        image_path = "./resources/test.png"
        seed_path = "./resources/seed.html"
        modified_seed_path = "./resources/modified/VG7.1_modified_seed.html"

        headers, encoder = get_request()
        modified_encoder = VG7_AddingResourceHeader.prepending_resource_header(encoder)

        self.assertEqual(headers["Connection"], "keep-alive")
        self.assertEqual(headers["User-Agent"], os.getenv("USER_AGENT"))
        self.assertEqual(headers["Content-Type"], modified_encoder.content_type)

        self.assertTrue(os.path.exists(modified_seed_path))
        with open(modified_seed_path, "rb") as modified_seed:
            with open(image_path, "rb") as image:
                with open(seed_path, "rb") as seed:
                    self.assertEqual(modified_seed.read(), image.read()[:1024] + seed.read())
                    seed.close()
                image.close()
            modified_seed.close()
        
        encoder.fields["image"][1].close()
        modified_encoder.fields["image"][1].close()

    def test_appending_resource_header(self):
        image_path = "./resources/test.png"
        seed_path = "./resources/seed.html"
        modified_seed_path = "./resources/modified/VG7.2_modified_seed.html"

        headers, encoder = get_request()
        modified_encoder = VG7_AddingResourceHeader.appending_resource_header(encoder)

        self.assertEqual(headers["Connection"], "keep-alive")
        self.assertEqual(headers["User-Agent"], os.getenv("USER_AGENT"))
        self.assertEqual(headers["Content-Type"], modified_encoder.content_type)

        self.assertTrue(os.path.exists(modified_seed_path))
        with open(modified_seed_path, "rb") as modified_seed:
            with open(image_path, "rb") as image:
                with open(seed_path, "rb") as seed:
                    self.assertEqual(modified_seed.read(), seed.read() + image.read(8))
                    seed.close()
                image.close()
            modified_seed.close()

        encoder.fields["image"][1].close()
        modified_encoder.fields["image"][1].close()

if __name__ == '__main__':
    unittest.main()