import requests
import random
import string
import os

from requests_toolbelt.multipart.encoder import MultipartEncoder
from utils.request import get_request
from utils.utils import is_vulnerable

class VG8_ConvertHTMLtoEML:
    def execute(file_upload_url):
        headers, encoder = get_request()
        modified_encoder = VG8_ConvertHTMLtoEML.modify_encoder(encoder)

        response = requests.post(file_upload_url, data=modified_encoder, headers=headers)
        status = "Vulnerable" if is_vulnerable(response.text, response.status_code) else "Not Vulnerable"
        
        encoder.fields["image"][1].close()
        modified_encoder.fields["image"][1].close()

        return {
            "ID": "VG8",
            "Name": "Converting HTML into EML",
            "Score": "6.3",
            "Severity": "Medium",
            "Status": status,
        }
        
    def modify_encoder(encoder):
        seed_path = "./resources/seed.html"
        modified_seed_path = "./resources/modified/VG8_modified_seed.eml"
        data = ''
        base_data='''TESTEML
Content-Type: text/html
Content-Transfer-Encoding: quoted-printable

'''
        normalstr = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ01234567890 \n\t'
        emlenc = lambda x: '='+hex(ord(x))[2:]

        with open(modified_seed_path, "w") as modified_seed:
            with open(seed_path, "r") as seed:
                for line in seed:
                    for char in line:
                        if char not in normalstr:
                            data +=emlenc(char)
                        else:
                            data += char
                seed.close()
            
            modified_seed.write(base_data+data)
            modified_seed.close()

        encoder = MultipartEncoder(
            fields={'image': ('VG8_modified_seed.eml', open(modified_seed_path, 'rb'), 'text/plain'), "submit": "submit"},
            boundary=encoder.boundary[2:],
        )

        return encoder